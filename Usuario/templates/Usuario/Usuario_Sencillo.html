
{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Usuario (Sencillo)</title>
  <link rel="stylesheet"stylesheet" href="../../static/styles/Usuario/Styles_Usuario_Sencillo.css">
</head>
<body>
  <div class="app">

    <!-- Header fijo (Buscador) -->
    <header class="header">
      <div class="search-pill">
        <a href="{% url 'Usuario_Inicio' %}">
          <button class="icon-btn home-btn" 
                  aria-label="Inicio" 
                  title="Inicio"></button>
        </a>
        
        <div class="pill-separator"></div>
        <div class="search">
          <span class="search-icon"></span>
          <input type="text"
                id="searchInput"
                placeholder="¬øQu√© quieres reproducir?"
          />
        </div>
        <div class="pill-separator"></div>
        <a href="{% url 'Usuario_Generos' %}">
        <button class="icon-btn action-btn"     aria-label="G√©neros" title="G√©neros"></button>
        </a>
    <!-- Bot√≥n Artista (nuevo) -->
    <a href="{% url 'Usuario_Artistas' %}">
      <button class="icon-btn artist-btn" aria-label="Artista" title="Artista"></button>
    </a>
      </div>
      <!-- dentro de tu <main> o donde quieras mostrar el icono de usuario -->
<div class="info-container">
  <button class="info-btn" onclick="toggleMenu()">üê¥</button>
  <div class="dropdown-menu" id="dropdownMenu">
    <a href="{% url 'Usuario_Configuracion' %}" class="dropdown-item">
      Configuraci√≥n de la cuenta
    </a>
    <!-- bot√≥n de cerrar sesi√≥n -->
    <a href="{% url 'login' %}" class="dropdown-item">
      Cerrar sesi√≥n
    </a>
  </div>
</div>

    </header>

    <!-- Sidebar fijo -->
    <aside class="sidebar">
      <!-- Biblioteca (imagen + texto) -->
      <div class="sidebar-library">
        <span class="biblioteca-icon"></span>
        <span class="sidebar-text">Biblioteca</span>
      </div>
    
      <hr class="sidebar-divider">
    
      <!-- Tus me gusta -->
      <button class="playlist-item favorite-item">
        <span class="favorite-icon"></span>
        <span class="playlist-label">Tus me gusta</span>
      </button>
    
      <!-- Playlists din√°micas -->
      <div id="playlist-list" class="sidebar-playlists">
        <!-- Aqu√≠ se ir√°n insertando las playlists -->
         {% for playlist in playlists %}
      <!-- aqu√≠ tus enlaces o botones generados -->
        {% endfor %}

      </div>
    
      <!-- Bot√≥n fijo abajo -->
      <button id="btn-new-playlist" class="sidebar-action">
        <span class="action-icon"></span>
        <span class="action-label">Crear playlist</span>
      </button>
    
      <!-- Formulario para crear nueva playlist -->
      <form
        id="new-playlist-form"
        class="new-playlist-entry hidden"
        action="/api/songs"
        method="POST"
      >
        <input
          type="text"
          name="name"
          id="new-song-name"
          placeholder="Nombre de la canci√≥n"
          required
        >
        <button type="submit" class="playlist-save-btn">
          Guardar
        </button>
      </form>
    </aside>

    <!-- Contenido principal: detalle de sencillo -->
    <main class="main-content">

      <!-- Encabezado gris del sencillo -->
      <section class="sencillo-header">
        <div class="artwork">
          <img src="{{ cancion.portada.url }}" alt="{{ cancion.portada }}">
        </div>
        <div class="info">
          <span class="label">Sencillo</span>
          <h1 class="title">{{ cancion.nombre }}</h1>
          <h2 class="artist">{{ cancion.usuario.nombre }}</h2>

          <p class="year">A√±o de lanzamiento: {{ cancion.fecha_lanzamiento }}</p>
          <p class="count">Cantidad de canciones: 1</p>
        </div>
      </section>

      <!-- Bot√≥n grande de play -->
      <section class="play-section">
        <button id="bigPlayButton" class="play-album" aria-label="Reproducir sencillo"></button>
      </section>

      <!-- Lista de pistas (una sola fila fija) -->
<table class="tracklist">
  <thead>
    <tr>
      <th>#</th>
      <th>T√≠tulo</th>
      <th>Artista</th>
      <th><span class="icon-clock"></span></th>
      <th>M√°s</th>
    </tr>
  </thead>
  <tbody>
    <!-- L√≠nea separadora -->
    <tr class="separator">
      <td colspan="5">
        <hr>
      </td>
    </tr>
    <tr data-song-id="{{ cancion.id }}">
      <td>1</td>
      <td>{{ cancion.nombre }}</td>
      <td>{{ artista.nombre }}</td>
      <td>{{ cancion.duracion }}</td>
      <td>
        <div class="options-wrapper">
          <button
            type="button"
            class="icon-btn mas-options-btn"
            aria-label="M√°s opciones"
            title="M√°s opciones">
          </button>

          <div class="dropdown-menu">
            <button
              type="button"
              class="dropdown-item"
              data-action="playlist">
              <img src="../../static/icons/plus.svg" alt="+">
              Agregar a playlist
            </button>
            <form
              method="post"
              action=""
              class="dropdown-form">
              {% csrf_token %}
              <button
                type="submit"
                class="dropdown-item like-item">
                <img src="../.../static/icons/heart.svg" alt="‚ô•">
                Agregar a mis me gusta
              </button>
            </form>
          </div>

          <!-- ‚ñ∫ sub-men√∫ de playlists -->
          <div class="playlist-menu">
            {% for playlist in playlists %}
              <form
                method="post"
                action="{% url 'playlist_add_song' playlist.id %}"
                class="dropdown-form">
                {% csrf_token %}
                <input type="hidden" name="song" value="{{ cancion.id }}">
                <button
                  type="submit"
                  class="dropdown-item playlist-item">
                  {{ playlist.nombre }}
                </button>
              </form>
            {% empty %}
              <div class="dropdown-item no-playlists">
                No tienes playlists
              </div>
            {% endfor %}
          </div>
          <!-- FIN sub-men√∫ -->

        </div>
      </td>
    </tr>
  </tbody>
</table>


    </main>

    <!-- Reproductor fijo (Footer) -->
    <footer class="player">
      <audio class="audio-player" id="audioPlayer">
      </audio>
      <div class="player-bottom">
        <div class="progress-wrapper">
          <div class="controls">
            <button class="control-btn aleatorio-btn" aria-label="Aleatorio" title="Aleatorio"></button>
            <button class="control-btn atras-btn"     aria-label="Anterior"   title="Anterior"></button>
            <button class="control-btn play-btn"      aria-label="Play/Pausa" title="Play/Pausa"></button>
            <button class="control-btn siguiente-btn" aria-label="Siguiente"  title="Siguiente"></button>
          </div>
          <div class="progress-container">
            <span class="time current">0:00</span>
            <input type="range" class="progress" min="0" max="100" value="0">
            <span class="time total">{{ cancion.duracion }}</span>
          </div>
        </div>
        <div class="volume-container">
          <button class="volume-icon" aria-label="Volumen" title="Volumen"></button>
          <input type="range" class="volume-slider" min="0" max="100" value="100">
        </div>
        <div class="track-info-container">
          <div class="info">
            <span class="track-name">{{ cancion.nombre }}</span>
            <span class="artist-name">{{ artista.nombre }}</span>
          </div>
          <div class="album-art">
            <img src="{{ cancion.portada.url }}" alt="{{ cancion.portada }}">
          </div>
        </div>
      </div>
    </footer>

  </div>

  <!-- Scripts -->
  <script src="../../static/js/volumen.js"></script>
  <script src="../../static/js/controles.js"></script>
  <script src="../../static/js/Crear_Playlist.js"></script>
  <script src="../../static/js/Agregar_Playlist.js"></script>
  <script src="../../static/js/Artista_Salir.js"></script>
  <script src="../../static/js/Usuario_Sencillo.js"></script>
</body>
</html>

<script>
  document.addEventListener("DOMContentLoaded", function () {
  const bigPlayButton = document.getElementById("bigPlayButton");
  const footerPlayButton = document.querySelector(".play-btn");
  const audioPlayer = document.querySelector(".audio-player");
  const progressBar = document.querySelector(".progress");
  const currentTimeLabel = document.querySelector(".time.current");
  const totalTimeLabel = document.querySelector(".time.total");

  const audioSrc = "{{ cancion.archivo.url }}";
  let audioLoaded = false;
  let isSeeking = false;
  let reproduccionRegistrada = false;

  // Funci√≥n para reproducir o pausar
  function togglePlay() {
    if (!audioLoaded) {
      audioPlayer.src = audioSrc;
      audioPlayer.load();
      audioLoaded = true;
    }

    if (audioPlayer.paused) {
      audioPlayer.play();
      updatePlayState(true);
      // Registrar la reproducci√≥n solo una vez
      if (!reproduccionRegistrada) { 
        fetch("{% url 'registrar_reproduccion' cancion.id %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
          }
        }).then(response => {
          if (response.ok) {
            console.log("Reproducci√≥n registrada correctamente.");
            reproduccionRegistrada = true; // Evitar registrar m√∫ltiples veces
          } else {
            console.error("Error al registrar la reproducci√≥n.");
          }
        }).catch(error => {
          console.error("Error de red al registrar la reproducci√≥n:", error);
        });
      }
    } else {
      audioPlayer.pause();
      updatePlayState(false);
    }
  }

  // Actualiza el estado visual de los botones
  function updatePlayState(isPlaying) {
    bigPlayButton.classList.toggle("playing", isPlaying);
    footerPlayButton.classList.toggle("playing", isPlaying);
  }

  // Eventos para botones
  bigPlayButton.addEventListener("click", togglePlay);
  footerPlayButton.addEventListener("click", togglePlay);

  // Actualizar progreso autom√°ticamente (solo si no est√° buscando)
  audioPlayer.addEventListener("timeupdate", function () {
    if (audioPlayer.duration && !isSeeking) {
      const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
      progressBar.value = progress;

      const mins = Math.floor(audioPlayer.currentTime / 60);
      const secs = Math.floor(audioPlayer.currentTime % 60).toString().padStart(2, '0');
      currentTimeLabel.textContent = `${mins}:${secs}`;
    }
  });

  // Mostrar duraci√≥n cuando se carga el audio
  audioPlayer.addEventListener("loadedmetadata", function () {
    const mins = Math.floor(audioPlayer.duration / 60);
    const secs = Math.floor(audioPlayer.duration % 60).toString().padStart(2, '0');
    totalTimeLabel.textContent = `${mins}:${secs}`;
  });

  // Al finalizar el audio
  audioPlayer.addEventListener("ended", function () {
    updatePlayState(false);
  });

  // Inicia b√∫squeda (rat√≥n o t√°ctil)
  progressBar.addEventListener("mousedown", () => isSeeking = true);
  progressBar.addEventListener("touchstart", () => isSeeking = true);

  // Cambiar el tiempo mientras se arrastra
  progressBar.addEventListener("input", function () {
    if (audioPlayer.duration) {
      const newTime = (progressBar.value / 100) * audioPlayer.duration;
      audioPlayer.currentTime = newTime;

      const mins = Math.floor(audioPlayer.currentTime / 60);
      const secs = Math.floor(audioPlayer.currentTime % 60).toString().padStart(2, '0');
      currentTimeLabel.textContent = `${mins}:${secs}`;
    }
  });

  // Termina b√∫squeda (rat√≥n o t√°ctil)
  progressBar.addEventListener("mouseup", () => isSeeking = false);
  progressBar.addEventListener("touchend", () => isSeeking = false);
});
</script>

